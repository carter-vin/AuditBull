# Audit Bull
## Audit Bull is the leading website for auditing .........


# Table Of Content
- [Audit Bull](#audit-bull)
  - [Audit Bull is the leading website for auditing .........](#audit-bull-is-the-leading-website-for-auditing-)
- [Table Of Content](#table-of-content)
- [Folder Structure](#folder-structure)
- [Run and Install](#run-and-install)
    - [`yarn install` or `yarn`](#yarn-install-or-yarn)
    - [`yarn dev`](#yarn-dev)
    - [`yarn run build`](#yarn-run-build)
    - [`yarn add <package-nanme>`](#yarn-add-package-nanme)
- [Used UI Libraries](#used-ui-libraries)
- [Formatting Code Automatically](#formatting-code-automatically)
- [Adding Image](#adding-image)
- [Integration](#integration)
  - [Working with Amplify](#working-with-amplify)
  - [Working with Cognioto](#working-with-cognioto)
  - [AdminQuries](#adminquries)
    - [How to user admin queries](#how-to-user-admin-queries)
    - [Adding custom function on admin queries](#adding-custom-function-on-admin-queries)
  - [Graphql API Amplify](#graphql-api-amplify)
  - [Using React Query with aws amplify](#using-react-query-with-aws-amplify)
    - [Uses of use Mutation](#uses-of-use-mutation)

# Folder Structure
Auditbull project is based on Next js with latest version (18.1.0) at the time of creation.
After clone of the project its looks like 
```
auditbull
    .husky
    .next
    amplify/*
    node_modules/*
    public/
        icons
        logo
        svgs
    src/
        components/*
        hooks/*
        layouts/*
        models/*
        modules/*
        pages/*
        styles/*
        utils/*
        aws-exports.js
    ...others
```
You can add images, logo into public folder selecting appropriate folder based on `icons logo svgs`
Creating new modules like `admin,user` you can get through `src/modules`.
You `hooks` can be use to create some internal state management. 

```
    import {useAppData} from 'hooks/useAppData.tsx';
    const {
        <your data>
    } = useAppData()

    please look useUsers hook for referece
```

`models` is auto generated by the `ampliy` once you create `graphql schema` and update `amplify`    
Use `pages/` to create page  that can be switch with routes

# Run and Install
In this project, you can run: 

### `yarn install` or `yarn`
Be sure to use `yarn install` or `yarn` to install all required package holding on package json.

### `yarn dev`
Builds the app for local. With this script you can run the project locally. 
Its will run the project on default port `3000` hosting on url `http://localhost:3000`.

### `yarn run build`
Builds the app for production to the build folder.
It correctly bundles React in production mode and optimizes the build for the best performance.
The build is minified and the filenames include the hashes.
Your app is ready to be deployed!
See the section about deployment for more information.

### `yarn add <package-nanme>`
To add the package/ dependency on this project.

# Used UI Libraries
- Material UI
- Tailwind CSS
- React Select
- Materail Data Grid
- Lodash
- Husky
- Prettier
- React Mention
- AWS Amplify
- React Query 
    - For wrapping aws api called with `useQuery` and `useMutations`.
    - React Query also cache query data. 
# Formatting Code Automatically
Prettier is an opinionated code formatter with support for JavaScript, CSS and JSON. With Prettier you can format the code you write automatically to ensure a code style within your project. See the [Prettier's GitHub page](https://github.com/prettier/prettier) for more information, and look at this [page to see it in action](https://prettier.github.io/prettier/).

To format our code whenever we make a commit in git, we need to install the following dependencies:

```sh
npm install --save husky lint-staged prettier
```

Alternatively you may use `yarn`:

```sh
yarn add husky lint-staged prettier
```

* `husky` makes it easy to use githooks as if they are npm scripts.
* `lint-staged` allows us to run scripts on staged files in git. See this [blog post about lint-staged to learn more about it](https://medium.com/@okonetchnikov/make-linting-great-again-f3890e1ad6b8).
* `prettier` is the JavaScript formatter we will run before commits.

Now we can make sure every file is formatted correctly by adding a few lines to the `package.json` in the project root.

Add the following line to `scripts` section:

```diff
  "scripts": {
+   "precommit": "lint-staged",
    "start": "react-scripts start",
    "build": "react-scripts build",
```

Next we add a 'lint-staged' field to the `package.json`, for example:

```diff
  "dependencies": {
    // ...
  },
+ "lint-staged": {
+   "src/**/*.{js,jsx,json,css}": [
+     "prettier --single-quote --write",
+     "git add"
+   ]
+ },
  "scripts": {
```

Now, whenever you make a commit, Prettier will format the changed files automatically. You can also run `./node_modules/.bin/prettier --single-quote --write "src/**/*.{js,jsx}"` to format your entire project for the first time.

Next you might want to integrate Prettier in your favorite editor. Read the section on [Editor Integration](https://github.com/prettier/prettier#editor-integration) on the Prettier GitHub page.

PS: Auditbull is using `coding convention` provided by `airbnb`. 

# Adding Image
Auditbull use default `image` component provided by the nextjs.
```
    import Image from 'next/image'

    <Image {...props}/>
``` 

Also for some small and minor images Audit bull is using image provided by material ui. 

# Integration
As mention above on `used libraries`, We are using mulitple libraries to build the application. `Amplify, react-query` are one of most important plugin to work on.

## Working with Amplify
[AWS Amplify](https://aws.amazon.com/amplify/) is a set of purpose-built tools and features that lets frontend web and mobile developers quickly and easily build full-stack applications on AWS, with the flexibility to leverage the breadth of AWS services as your use cases evolve.

You can follow this link to mock the amplify setup
[Amplify Docs](https://docs.amplify.aws/)

Audit Bull Has two environment for working on amplify
- Audit Bull Environment
  - Staging (for all production and staging )
  - Dev (for all development process)
  - Switching between the amplify
    - to get into dev ```amplify env checkout dev```
    - to get into staging ```amplify env checkout staging```
  - When to switch env.
    - On developmenet, local working on our machine: `amplify env must be dev`
    - On Production/Staging, local working on our machine: `amplify env must be staging`
  - To verify env, 
    - check aws-exports.js, there will be  `aws_cloud_logic_custom` has staging `adminqueries`
    - in staging
    ```
        aws_cloud_logic_custom: [
                {
                    "name": "AdminQueries",
                    "endpoint": "https://xxxxxxx.execute-api.us-east-1.amazonaws.com/staging",
                    "region": "us-east-1"
                }
            ],
    ```
     - in dev
    ```
        aws_cloud_logic_custom: [
                {
                    "name": "AdminQueries",
                    "endpoint": "https://xxxxxxxx.execute-api.us-east-1.amazonaws.com/dev",
                    "region": "us-east-1"
                }
            ],
    ```

- Authentication
  - Auditbull get authenticate with `cognito user` and `amplify auth`
  - Some implemented auth methods are 
    - Google 
    - Teams
    - Slack
    - Auth.sign() (with users email and password) (not register)
  - Authentication is truely based on cognito user. 
  - Authentication used `openID` authentication for `teams slack`
  - Google can be create by amplify with the script `amplify add auth`
  - All amplify functions and data are store in folder `amplify/*`


- Availabel script in amplify
  - ` amplify add auth ` to add auth
  - ` amplify update auth ` to update auth
  - ` amplify add api ` to create api either rest or graphql
  - ` amplify push ` to push the latest code of amplify  on cloud amplify
  - ` amplify pull ` to pull code of latest amplify from  colud amplify to local
  
## Working with Cognioto
[Amazon Cognito](https://aws.amazon.com/cognito/) lets you add user sign-up, sign-in, and access control to your web and mobile apps quickly and easily. Amazon Cognito scales to millions of users and supports sign-in with social identity providers, such as Apple, Facebook, Google, and Amazon, and enterprise identity providers via SAML 2.0 and OpenID Connect.

As above metion on authentication:
- As we created two env for amplify, we have two cogniot user pool
  - staging
  - dev

- Cognito used OpenID connection for authentication
- Cognito groups users based on `roles` and `openID`
- Setting up `OpenID`
    - On user pools, navigate to identify providers
    - Click on OpenID Connect
    - Filled all required filed on the openID connect form with select appropriate provider.

## AdminQuries 
Admin queries gives all the data that required admin authentication such as user list. 
Setting up admin queries
- `ampliy add auth`
  - choose amplify admin queires
  - create guard such as admin/user
  - Follow this [Docs](https://docs.amplify.aws/cli/auth/admin/)

### How to user admin queries
```
    const requestInfo = {
       queryStringParameters: {
            groupname: "Editors",
            limit: limit,
            token: nextToken
        },
        headers: {
            'Content-Type': 'application/json',
            Authorization: `${(await Auth.currentSession())
                .getAccessToken()
                .getJwtToken()}`,
        },
    };
 const res = await API.post('AdminQueries', '/listUsersInGroup', requestInfo);
```

### Adding custom function on admin queries
- Go to amplify/* 
- Get into amplify/backedn/function/Admin......./src
- You can see there files
  - app.js (main entry point)
  - cognitoActions.js (collection of actions)
  - index.js (entry point)
- Finally add related `Action` on `PolicyDocument` on AdminQureis...... outside of src on same folder

## Graphql API Amplify
- API, Application Progarm Interface.
- [Amplify CLI's GraphQL API](https://docs.amplify.aws/cli/graphql/overview/) category makes it easy for you to create a new GraphQL API backed by a database. Just define a GraphQL schema and Amplify CLI will automatically transform the schema into a fully functioning GraphQL API powered by AWS AppSync, Amazon DynamoDB, and more.
- Adding graphql api 
```
    amplify add api
```
- Follow the bleow instruction [Docs](https://docs.amplify.aws/cli/graphql/overview/)
- Schema 
  ```
    type System @model @auth(rules: [{ allow: public }]) {
        id: ID!
        name: String
        status: String
        owner: AWSJSON
        type: String
        description: String
        vendor_provided: Boolean
        customer_facing_info_system: Boolean
        location: AWSJSON
        risk: AWSJSON
        data_classification: AWSJSON
        compliance: AWSJSON
        Vendors: Vendors @hasOne
    }
  ```

## Using React Query with aws amplify
[React Query](https://react-query.tanstack.com/overview) is often described as the missing data-fetching library for React, but in more technical terms, it makes fetching, caching, synchronizing and updating server state in your React applications a breeze.

- useQuery
- useMutation

### Uses of use Mutation
```
    <!-- functions -->
    const createSystem = async (payload: ISytemPayload) => {
        const createSystemMutation = `
            mutation CreateSystem {
                    createSystem(input: {
                        name: "${payload.name}", 
                        status: "${payload.status}", 
                        type: "${payload.type}", 
                        description: "${payload.description}", 
                    }) {
                        id
                        name
                    }
            }
        `;
        return API.graphql(graphqlOperation(createSystemMutation));
    };

    const { isLoading, mutate } = useMutation(createSystem /* function */, {
        mutationKey: 'createSystem', (name for key)
        onSuccess: (res) => {
            /*
                success 
            */
            console.log('res', res)
        },
        onError: (error: any) => {
            /*
            Return error message 
            */
        },
    });

    mutate(values);
```